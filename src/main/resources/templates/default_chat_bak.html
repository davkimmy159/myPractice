<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="default">
<head>

<!-- bootstrap & its theme css is loaded here by upper layer -->

<!-- custom elements in <head> tag -->
<script src="//cdn.ckeditor.com/4.5.8/standard/ckeditor.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.0/sockjs.min.js" type="text/javascript"></script>
<style type="text/css">
body {
	padding-top: 58px;
}

#refresh, #showHeights {
	cursor: pointer;
}

#basicStatus {
	margin-right: 1em;
	cursor: default;
	opacity: 1;
}

#mobileStatus {
	opacity: 1;
	cursor: default;
}

.badge {
	margin-left: 5px;
}
</style>
<title>default_chat</title>
</head>
<body>
	<!-- Substitution of 'body' on upper layer -->
	<div layout:fragment="body" id="container" class="container-fluid">
		<nav id="vavBar" class="navbar navbar-default navbar-fixed-top navbar-inverse">
			<div id="navBarContainer" class="container-fluid">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#colla-collapse-1">
						<span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span>
					</button>
					<button id="mobileStatus" name="status" type="button" class="btn btn-primary btn-xs navbar-toggle collapsed visible-xs-inline active" disabled="disabled">
						Mobile<span id="mobileStatusBadge" class="badge">0</span>
					</button>
					<a id="IMColla" class="navbar-brand btn" data-toggle="modal" data-target="#modal">IMColla</a>
				</div>

				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse" id="colla-collapse-1">
					<!-- form -->
					<form id="nicknameForm" class="navbar-form navbar-left" role="Join">
						<div class="form-group">
							<input id="nicknameInput" type="text" class="form-control" placeholder="Type nickname" />
							<input hidden="hidden" />
						</div>
						<div id="btnGroup1" class="btn-group" role="group" aria-label="...">
							<div class="btn-group" role="group">
								<button id="joinToggleBtn" type="button" class="btn btn-success" data-toggle="tooltip" data-placement="bottom" data-container="body" title="Type your name and Join">Join</button>
							</div>
							<div class="btn-group" role="group">
								<input id="toolbarToggleBtn" type="button" class="btn btn-default" data-toggle="tooltip" data-placement="bottom" data-container="body" title="Remove toolbar if it's necessary" value="Hide toolbar" />
							</div>
						</div>
					</form>

					<!-- navbar left -->
					<ul class="nav navbar-nav">
						<!-- dropdown -->
						<li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"> Dropdown <span class="caret"></span>
						</a>
							<ul class="dropdown-menu" role="menu">
								<li><a id="showHeights">show heights</a></li>
								<li><a href="#">test2</a></li>
								<li><a href="#">test3</a></li>
								<li class="divider"></li>
								<li><a href="#">test4</a></li>
							</ul></li>
					</ul>

					<!-- navbar right -->
					<ul class="nav navbar-nav navbar-right">
						<li><button id="basicStatus" name="status" type="button" class="btn btn-primary navbar-btn hidden-xs active" disabled="disabled">
								Basic<span id="basicStatusBadge" class="badge">0</span>
							</button></li>
					</ul>
				</div>
				<!-- .navbar-collapse -->
			</div>
			<!-- .container-fluid -->
		</nav>
		<!-- .navbar -->

		<!-- replaced here by under layer -->
		<div layout:fragment="main"></div>
	</div>

	<!-- jQuery & bootstrap JS is loaded here by upper layer -->

	<!-- Substitution of 'customScript' -->
	<script layout:fragment="customScript" type="text/javascript">
		// CKEditor setting	
		var basicEditor = CKEDITOR.replace('basicEditor');
		var mobileEditor = CKEDITOR.inline('mobileEditor');
		basicEditor.config.resize_enabled = false;
		basicEditor.config.removePlugins = 'elementspath';

		// socket(SockJS)
		var session = {
			
			socket : null,
			nickname : null,
			
			connect : function() {
				var URL = location.protocol + '//' + location.host;
				this.socket = new SockJS(URL + '/myPractice/socket');

				this.socket.onopen = function(event) {
					utils.chatAppend('연결 성공');
				};

				this.socket.onclose = function(event) {
					utils.chatAppend('연결 종료');
					// Unespected disconnection
					if (jqObj.joinToggleBtn.html() == ('Exit')) {
						utils.chatAppend('Unstable disconnection happened!');
						utils.chatAppend('Please join again!');
						jqObj.joinToggleBtn.html('Join');
						jqObj.joinToggleBtn.removeClass('btn-danger');
						jqObj.joinToggleBtn.addClass('btn-success');
					}
				};

				this.socket.onmessage = function(event) {
					utils.chatAppend(event.data);
					badge.add();
				};

				this.socket.onerror = function(event) {
					alert('에러 발생 : ' + event.data);
				};
				URL = null;
			},
			
			disconnect : function() {
				this.socket.send(this.nickname + ' 님이 퇴장했습니다.');
				this.socket.close();
				this.socket = null;
				this.nickname = null;
			},
			
			// Send data to socket
			send : function() {
				var msg = jqObj.chatInput.val();
				if (this.socket) {
					utils.chatAppend('나 : ' + msg);
					this.socket.send(session.nickname + ' : ' + msg);
					jqObj.chatInput.val('');
				} else {
					utils.chatAppend('You need to join first!');
				}
				msg = null;
			},
			
			onOpen : function(event) {
				utils.chatAppend('연결 성공');
			},

			onClose : function(event) {
				utils.chatAppend('연결 종료');
				// Unespected disconnection
				if (jqObj.joinToggleBtn.html() == ('Exit')) {
					utils.chatAppend('Unstable disconnection happened!');
					utils.chatAppend('Please join again!');
					jqObj.joinToggleBtn.html('Join');
					jqObj.joinToggleBtn.removeClass('btn-danger');
					jqObj.joinToggleBtn.addClass('btn-success');
				}
			},

			onMessage : function(event) {
				utils.chatAppend(event.data);
				badge.add();
			},

			onError : function(event) {
				alert('에러 발생 : ' + event.data);
			}
		};
		
		var jqObj = {
				
			chatArea : $('#chatArea'),
			chatInput : $('#chatInput'),
			chatInputBtn : $('#chatInputBtn'),
			joinToggleBtn : $('#joinToggleBtn'),
			nicknameInput : $('#nicknameInput'),
			toolbarToggleBtn : $('#toolbarToggleBtn'),
			formGroup1 : $('#formGroup1'),
			formGroup2 : $('#formGroup2'),
			formGroup3 : $('#formGroup3'),
			editorContainer : $('#editorContainer'),
			chatContainer : $('#chatContainer'),
			mobileEditor : $('#mobileEditor'),
			editorInputBtn : $('#editorInputBtn'),
			btnGroup1 : $('#btnGroup1'),
			basicStatus : $('#basicStatus'),
			mobileStatus : $('#mobileStatus'),
			IMColla : $('#IMColla')
			
		};
		
		var badge = {
			
			msgCnt : 0,
			badgeArray : $('.badge'),
			badgeBtnArray : [ jqObj.basicStatus, jqObj.mobileStatus ],
			
			add : function() {
				if(this.msgCnt == 0) {
					utils.removeClassFunc(this.badgeBtnArray, 'btn-primary');
					utils.addClassFunc(this.badgeBtnArray, 'btn-warning');
				}
				this.badgeArray.text(++this.msgCnt);
			},
			
			reset : function() {
				this.msgCnt = 0;
				this.badgeArray.text(0);
				utils.removeClassFunc(this.badgeBtnArray, 'btn-warning');
				utils.addClassFunc(this.badgeBtnArray, 'btn-primary');
			},
			
			startBlink : function() {
				this.badgeBtnArray.fadeOut(500);
				this.badgeBtnArray.fadeIn(500);
			},
			
			stopBlink : function() {
			}
			
		};
		
		var utils = {

			// chatArea append function
			chatAppend : function(str) {
				jqObj.chatArea.append(str + '\n');
				jqObj.chatArea.scrollTop(jqObj.chatArea[0].scrollHeight);
			},
				
			addClassFunc : function(array, str) {
				for ( var ctr in array)
					array[ctr].addClass(str);
			},
			
			removeClassFunc : function(array, str) {
				for ( var ctr in array)
					array[ctr].removeClass(str);
			},
				
			// Check if string is not both null and empty
			checkStr : function(str) {
				//<![CDATA[
				if (((typeof str != "undefined") && (typeof str.valueOf() == "string")) && (str.length > 0))
					return true;
				else
					return false;
				//]]>
			},
			
			// Verify and control Join condition
			verifyJoin : function() {
				if (!session.socket) {
					if (this.checkStr(jqObj.nicknameInput.val())) {
						this.chatAppend('Join now!');
						jqObj.joinToggleBtn.html('Exit');
						jqObj.joinToggleBtn.removeClass('btn-success');
						jqObj.joinToggleBtn.addClass('btn-danger');
						session.nickname = jqObj.nicknameInput.val();
						jqObj.nicknameInput.val('');
						jqObj.nicknameInput.attr('placeholder', 'Login is successful!');
						session.connect();
						jqObj.chatInput.focus();
						this.socket.send(session.nickname + ' 님이 입장했습니다.');
					} else {
						jqObj.nicknameInput.attr('placeholder', 'Worng! type again!');
						jqObj.nicknameInput.focus();
					}
				} else {
					this.chatAppend('Exit now!');
					jqObj.joinToggleBtn.html('Join');
					jqObj.joinToggleBtn.removeClass('btn-danger');
					jqObj.joinToggleBtn.addClass('btn-success');
					jqObj.nicknameInput.val('');
					jqObj.nicknameInput.attr('placeholder', 'Type nickname');
					session.disconnect();
					jqObj.nicknameInput.focus();
					
				}
			},
			
			showHeight : function() {
				// Each height
				this.chatAppend('#window : ' + $(window).height());
				this.chatAppend('#container : ' + $('#container').height());
				this.chatAppend('#navBarContainer: ' + $('#navBarContainer').height());
				this.chatAppend('#mainRow : ' + $('#mainRow').height());
				this.chatAppend('#editorContainer : ' + jqObj.editorContainer.height());
				this.chatAppend('#chatContainer : ' + jqObj.chatContainer.height());
				this.chatAppend('#basicEditorDiv : ' + $('#basicEditorDiv').height());
				this.chatAppend('#mobileEditorDiv : ' + $('#mobileEditorDiv').height());
				this.chatAppend('#basicEditor : ' + $('#basicEditor').height());
				this.chatAppend("#basicEditor.config.height : " + basicEditor.config.height);
				this.chatAppend('#mobileEditor : ' + jqObj.mobileEditor.height());
				this.chatAppend('#chatArea : ' + jqObj.chatArea.height());
				this.chatAppend('#chatContainer - editorContainer : ' + (jqObj.chatContainer.height() - jqObj.editorContainer.height()));
				this.chatAppend('toolbar toggle button : ' + jqObj.toolbarToggleBtn.val());
			}
		};

		var eventFuncs = {

			tooltipActivate : function() {
				$('[data-toggle="tooltip"]').tooltip();
			},
			
			focusBackToChatInput : function() {
				// Focus back to chatInput on pressing enter key on chatInput
				jqObj.chatInput.keypress(function(event) {
					if (event.keyCode === 13) {
						if ((jqObj.chatInput.val())) {
							session.send();
							jqObj.chatInput.focus();
						}
					}
				});

				// Focus back to chatInput on clicking chatInputBtn
				jqObj.chatInputBtn.click(function() {
					if ((jqObj.chatInput.val()))
						session.send();
					jqObj.chatInput.focus();
				});
			},

			badgeEvent : function() {
				// Badge event function
				jqObj.chatArea.focus(function(event) {
					badge.reset();
				});
				jqObj.chatInput.focus(function(event) {
					badge.reset();
				});
			},
			
			toggleJoinEvent : function() {
				// Toggle join (button)
				jqObj.joinToggleBtn.click(function() {
					utils.verifyJoin();
				});

				// Toggle join (input text)
				jqObj.nicknameInput.keypress(function(event) {
					if (event.keyCode === 13)
						if (!session.socket)
							utils.verifyJoin();
				});
			},
			
			// Toggle toolbar
			toggleToolbarEvent : function() {
				jqObj.toolbarToggleBtn.click(function() {
					if (jqObj.toolbarToggleBtn.val() == 'Hide toolbar') {
						$('#cke_1_top').hide();
						$('#cke_2_top').hide();
						jqObj.toolbarToggleBtn.val('Show toolbar');
					} else {
						$('#cke_1_top').show();
						$('#cke_2_top').show();
						jqObj.toolbarToggleBtn.val('Hide toolbar');
					}
					if (matchMedia("screen and (min-width: 768px)").matches) {
						resizeFuncs.setBasicHeight();
					}
				});
			},
			
			windowOutEvent : function() {
				// Logout, close event with 'esc' key on browser window
				$(window).keydown(function(event) {
					if (event.keyCode == 27) {
						utils.chatAppend('esc!!');
						if (session.socket) {
							utils.chatAppend('Exit now!');
							jqObj.joinToggleBtn.html('Join');
							jqObj.joinToggleBtn.removeClass('btn-danger');
							jqObj.joinToggleBtn.addClass('btn-success');
							jqObj.nicknameInput.val('');
							jqObj.nicknameInput.attr('placeholder', 'Type nickname');
							session.disconnect();
							session.nickname = null;
						} else {
							// 창 닫는 함수 (작동 안 함)
							// window.open("about:blank","_self").close();
						}
					}
				});
			},
			
			showHeights : function() {
				$('#showHeights').click(function() {
					utils.showHeight();
				});
			},
			
			addAll() {
				this.focusBackToChatInput();
				this.badgeEvent();
				this.toggleJoinEvent();
				this.toggleToolbarEvent();
				this.windowOutEvent();
				this.showHeights();
				this.tooltipActivate();
			}
			
		};

		eventFuncs.addAll();
		
		var resizeFuncs = {
			
			// There was a problem that editor's height is not compatible with chatArea's one at some point
			// I think it was from CKEditor's toolbar height changes.
			// So I've deicded to use an if statement to ensure it's compatible when resizing
			checkEditorHeightAgainAndResize : function() {
				if (jqObj.editorContainer.height() != jqObj.chatContainer.height()) {
					basicEditor.resize('100%', jqObj.chatArea.height() + 63);
				}
			},
			
			setInitialBasicHeight : function() {
				jqObj.chatArea.height($(window).height() - 175);

				// CKEditor is loaded at the last moment, so I used 'on' method from CKEditor
				basicEditor.on('instanceReady', function() {
					basicEditor.resize('100%', jqObj.chatArea.height() + 63);
					this.checkEditorHeightAgainAndResize();
				});
			},
			
			setBasicHeight : function() {
				jqObj.chatArea.height($(window).height() - 175);
				basicEditor.resize('100%', jqObj.chatArea.height() + 63);
				this.checkEditorHeightAgainAndResize();
			},
			
			setMobileHeight : function() {
				jqObj.mobileEditor.height($(window).height() - 320);
				jqObj.chatArea.height($(window).height() - jqObj.mobileEditor.height() - 192);
			}
			
		};

		// == $(function() {
		$(document).ready(function() {

			jqObj.nicknameInput.focus();

			// Necessary arrays to set different sets between basic and mobile
			var formGroupArray = [ jqObj.formGroup1, jqObj.formGroup2, jqObj.formGroup3 ];
			var formControlArray = [ jqObj.editorInputBtn, jqObj.chatInputBtn ];

			// Initial setting
			if (matchMedia("screen and (min-width: 768px)").matches) {
				utils.chatAppend("큰 화면 전용");
				resizeFuncs.setInitialBasicHeight();
			} else {
				utils.chatAppend("작은 화면 전용");
				utils.removeClassFunc(formGroupArray, 'form-group');
				utils.addClassFunc(formControlArray, 'form-control');
				jqObj.btnGroup1.addClass('btn-group-justified');
				resizeFuncs.setMobileHeight();
			}

			$(window).resize(function() {
				// To basic from mobile
				if (matchMedia("screen and (min-width: 768px)").matches) {
					// resize editor, chatArea
					resizeFuncs.setBasicHeight();

					// Applied only once after mode has been changed
					if (!(formGroupArray[0].hasClass('form-group'))) {
						utils.chatAppend("큰 화면 전용");
						utils.removeClassFunc(formControlArray, 'form-control');
						utils.addClassFunc(formGroupArray, 'form-group');
						jqObj.btnGroup1.removeClass('btn-group-justified');
						resizeFuncs.setBasicHeight();
					}

				} else { // To mobile from basic
					// resize editor, chatArea
					resizeFuncs.setMobileHeight();

					// // Applied only once after mode has been changed
					if (formGroupArray[0].hasClass('form-group')) {
						utils.chatAppend("작은 화면 전용");
						utils.removeClassFunc(formGroupArray, 'form-group');
						utils.addClassFunc(formControlArray, 'form-control');
						jqObj.btnGroup1.addClass('btn-group-justified');
						resizeFuncs.setMobileHeight();
					}
				}
			}).resize();
		});
	</script>
</body>
</html>