<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="default">
<head>

<!-- bootstrap & its theme css is loaded here by upper layer -->

<!-- custom elements in <head> tag -->
<script src="//cdn.ckeditor.com/4.5.8/basic/ckeditor.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.0/sockjs.min.js" type="text/javascript"></script>
<style type="text/css">
body {
	padding-top: 65px;
}
</style>
<title>default_chat</title>
</head>
<body>
	<!-- Substitution of 'body' -->
	<div layout:fragment="body" class="container-fluid">
		<nav class="navbar navbar-default navbar-fixed-top navbar-inverse">
			<div class="container-fluid">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#colla-collapse-1">
						<span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" href="#">IMColla</a>
				</div>

				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse" id="colla-collapse-1">
					<!-- form -->
					<form class="navbar-form navbar-left" role="Join">
						<div class="form-group">
							<input id="nicknameInput" type="text" class="form-control" placeholder="Type nickname" />
						</div>
						<div class="form-group">
							<button id="joinBtn" type="button" class="btn btn-default">Join</button>
						</div>
					</form>

					<ul class="nav navbar-nav">
						<!-- navbar left -->
						<!-- dropdown -->
						<li><a href="#">test1</a></li>
						<li><a href="#">test2</a></li>
					</ul>

					<!-- navbar right -->
					<ul class="nav navbar-nav navbar-right">
						<li><a href="#">test3</a></li>
						<!-- dropdown -->
						<li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"> Dropdown <span class="caret"></span></a>
							<ul class="dropdown-menu" role="menu">
								<li><a href="#">test1</a></li>
								<li><a href="#">test2</a></li>
								<li><a href="#">test3</a></li>
								<li class="divider"></li>
								<li><a href="#">test4</a></li>
							</ul></li>
					</ul>
				</div>
				<!-- .navbar-collapse -->
			</div>
			<!-- .container-fluid -->
		</nav>
		<!-- .navbar -->


		<!-- replaced here by under layer -->
		<div layout:fragment="main"></div>
	</div>

	<!-- jQuery & bootstrap JS is loaded here by upper layer -->

	<!-- Substitution of 'customScript' -->
	<script layout:fragment="customScript" type="text/javascript">
		// CKEditor 설정

		CKConfig();
		
		CKConfig function() {
			CK_editor.config.height = window.innerHeight - 178;
			CK_editor.setData("test");

			CK_chatArea.config.height = window.innerHeight - 185;
			CK_chatArea.config.removePlugins = 'toolbar';
		};
		
		
		var chatInput = document.getElementById("chatInput");

		// JSock
		var URL = location.protocol + "//" + location.host;
		var socket = new SockJS(URL + "/myPractice/chatSocket");

		socket.onopen = function(event) {
			CK_chatArea.insertText('연결 성공\n');
		}
		socket.onclose = function(event) {
			CK_chatArea.insertText('연결 종료\n');
		}
		socket.onmessage = function(event) {
			CK_chatArea.insertText("상대 : " + event.data + "\n");
		}
		socket.onerror = function(event) {
			alert(event.data);
		}

		function send() {
			CK_chatArea.insertText("나 : " + chatInput.value + "\n");
			// CK_chatArea.insertHtml('<p style="border: 1px solid gold;">' + chatInput.value + '</p><br />');
			socket.send(chatInput.value);
			chatInput.value = "";
			chatInput.focus();
		}

		/*
		CK_chatArea.setData("test");
		CK_chatArea.plugins.add('simplebox', {
		button : 'Create a simple box'
		});
		
		CKEDITOR.editorConfig = function(config) {
			config.toolbar = 'Custom'; //makes all editors use this toolbar
			config.toolbar_Custom = []; //define an empty array or whatever buttons you want.
		};
		
		if (matchMedia("screen and (max-width: 767px)").matches) {
			chatAreaRows = "6";
		} else {
			document.getElementById("chatArea").rows = "28";
		}
		 */

		// 버튼 클릭, 엔터 키 입력 시 이벤트 메서드
		$("#chatInputBtn").click(function() {
			send();
		});
		$('#chatInput').keypress(function(event) {
			if (event.keyCode === 13) {
				send();
			}
		});
		$('#chatInput').click(function() {
			
		});

		$('#joinBtn').click(function() {
			// $('#nicknameInput').val('');
			$.ajax({
				url : 'http://localhost:8080/myPractice/',
				// data 속성 내부에 또다른 {}가 있다. 중괄호 내부는 객체이다.
				// data: 서버에 전송할 데이터로서 값은 key와 value로 이루어진 객체
				data : {
					'nickname' : $('#nicknameInput').val()
				},
				// 서버가 리턴해주는 데이터 타입
				dataType : 'json',
				type : 'POST',
				// 인자 result에는 서버에서 리턴해준 배열이 들어감
				// 배열이 들어온 이유는 dataType속성을 JSON으로 했기 때문에 리턴되는 데이터가 텍스트더라도 내부적으로 그 데이터를 JSON으로 해석하여 배열로 변환
				// 그래서 배열에 있는 result값을 체크해서 result가 true이면 성공 이벤트 관련 로직을 출력한다.
				// 서버와의 통신이 성공하면 호출되는 이벤트 핸들러인 function(result)
				// result 인자에는 서버가 리턴해주는 데이터가 들어감
				success : function(result) {
					//result['result']는 연상 배열인가 확인하자
					if (result['result'] == true) {
						CK_chatArea.insertText(result['nickname'] + " 이(가) 접속했습니다.\n");
					}
				}
			});
		});

		$(window).resize(function() {
			var a = 100;
			CK_editor.insertText("1");
			CK_chatArea.config.height;
		}).resize();

		// jQuery 없이 사용 가능한 메서드 (해당 태그의 이벤트 속성에 할당)
		/*
		function send2(event) {
			if (event.keyCode == 13) {
				send();
			}
		}
		 */

		// var beforeInnerHeight = window.innerHeight;
		// 해당 페이지의 인코딩 완료 시 jquery 적용
		$(document).ready(function() {

			/*
			$('#chatInput').live('keypress', function(event) {
				if (event.which == 13) {
					alert("you pressed enter key");
				}
			});
			
			$('#chatInput').on('keypress', function(e) {
				if (e.which == 13) {
					alert("you pressed enter key");
				}
			});
			
			$("#chatInput").keypress(function(){
				if (e.which == 13) {
					alert("you pressed enter key");
				}
			});
			
			$(window).resize(function() {
				var gap = beforeInnerHeight - window.innerHeight;
				if (gap > 0)
					CK_chatArea.config.height -= gap;
				else
					CK_chatArea.config.height += gap;
			});
			 */
		});
	</script>
</body>
</html>