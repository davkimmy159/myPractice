<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="default">
<head>

<!-- common js and css are loaded here by upper layer -->

<!-- custom elements in <head> tag -->
<!-- ckeditor.js -->
<script src="//cdn.ckeditor.com/4.5.8/standard/ckeditor.js"></script>

<!-- sockjs.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.0/sockjs.min.js" type="text/javascript"></script>

<style type="text/css">
body {
	padding-top: 58px;
}

#refresh, #showHeights {
	cursor: pointer;
}

#basicStatus {
	margin-right: 1em;
	cursor: default;
	opacity: 1;
}

#mobileStatus {
	opacity: 1;
	cursor: default;
}

.badge {
	margin-left: 5px;
}
</style>
<title>default_chat</title>
</head>
<body>
	<!-- Substitution of 'body' on upper layer -->
	<div layout:fragment="body" id="container" class="container-fluid">
		<nav id="vavBar" class="navbar navbar-default navbar-fixed-top navbar-inverse">
			<div id="navBarContainer" class="container-fluid">
				<!-- Brand and toggle get grouped for better mobile display -->
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#colla-collapse-1">
						<span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span>
					</button>
					<div class="btn-group visible-xs-block pull-right">
						<button id="mobileStatus" name="status" type="button" class="btn btn-primary navbar-btn" data-toggle="tooltip" data-placement="bottom" title="Hide toolbar!">
							Mobile<span id="mobileStatusBadge" class="badge">0</span>
						</button>
					</div>
					<a id="IMColla" class="navbar-brand btn" data-toggle="modal" data-target="#mainModal">IMColla</a>
				</div>

				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse" id="colla-collapse-1">
					<!-- form -->
					<form id="nicknameForm" class="navbar-form navbar-left" role="Join">
						<div class="form-group">
							<input id="nicknameInput" type="text" class="form-control" placeholder="Type nickname" />
							<input hidden="hidden" />
						</div>
						<div id="btnGroup1" class="btn-group" role="group" aria-label="...">
							<div class="btn-group" role="group">
								<button id="joinToggleBtn" type="button" class="btn btn-success" data-toggle="tooltip" data-placement="bottom" data-container="body" title="Type your name and Join">Join</button>
							</div>
						</div>
					</form>

					<!-- navbar left -->
					<ul class="nav navbar-nav">
						<!-- dropdown -->
						<li class="dropdown"><a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"> Dropdown <span class="caret"></span></a>
							<ul class="dropdown-menu" role="menu">
								<li><a id="test1">notify test 1</a></li>
								<li><a id="test2">notify test 2</a></li>
								<li><a id="test3">notify test 3</a></li>
								<li><a id="test4">notify test 4</a></li>
								<li class="divider"></li>
								<li><a id="showHeights">show heights</a></li>
							</ul></li>
					</ul>

					<!-- navbar right -->
					<ul class="nav navbar-nav navbar-right">
						<li>
							<button id="basicStatus" name="status" type="button" class="btn btn-primary navbar-btn hidden-xs" data-toggle="tooltip" data-placement="bottom" title="Hide toolbar!">
								Basic<span id="basicStatusBadge" class="badge">0</span>
							</button>
						</li>
					</ul>
				</div>
				<!-- .navbar-collapse -->
			</div>
			<!-- .container-fluid -->
		</nav>
		<!-- .navbar -->

		<!-- replaced here by under layer -->
		<div layout:fragment="main"></div>
	</div>

	<!-- jQuery & bootstrap JS is loaded here by upper layer -->

	<!-- Substitution of 'customScript' -->
	<script layout:fragment="customScript" type="text/javascript">
		// CKEditor setting	
		var basicEditor = CKEDITOR.replace('basicEditor');
		basicEditor.config.resize_enabled = false;
		basicEditor.config.removePlugins = 'elementspath';
		var mobileEditor = CKEDITOR.inline('mobileEditor');
		var memoEditor = CKEDITOR.inline('memoEditor');
		memoEditor.config.resize_enabled = false;
		$('#memoEditor').height(150);

		// PNotify initial setting
		PNotify.prototype.options.styling = "bootstrap3";
		
		// FullCalendar in modal
		var calendar = $("#calendar").fullCalendar({
			header: {
				left: 'prev,next today',
				center: 'title',
				right: 'month,agendaWeek,agendaDay'
			},
			editable: true,
			// for resizing (removing vertical scroll bar)
			contentHeight: 'auto',
			events: [
				{
					title: 'All Day Event',
					start: '2016-05-01'
				},
				{
					id: 999,
					title: 'Repeating Event',
					start: '2016-05-09T16:00:00'
				},
				{
					id: 999,
					title: 'Repeating Event',
					start: '2016-05-16T16:00:00'
				},
				{
					title: 'Meeting',
					start: '2016-05-12T10:30:00',
					end: '2016-05-12T12:30:00'
				},
				{
					title: 'Lunch',
					start: '2016-05-12T12:00:00'
				},
				{
					title: 'Birthday Party',
					start: '2016-05-13T07:00:00'
				},
				{
					title: 'Click for Google',
					url: 'http://google.com/',
					start: '2016-05-28'
				}
			]
		});
		
		$('#mainModal').on('shown.bs.modal', function () {
			calendar.fullCalendar('render');
		});
		
		
// ===================================================================================================
		
		var jqObj = {
				
				chatArea : $('#chatArea'),
				chatInput : $('#chatInput'),
				chatInputBtn : $('#chatInputBtn'),
				nicknameInput : $('#nicknameInput'),
				joinToggleBtn : $('#joinToggleBtn'),
				toolbarToggleBtn : $('#toolbarToggleBtn'),
				toolbarToggle : $('#toolbarToggle'),
				chatNotifyToggleBtn : $('#chatNotifyToggleBtn'),
				chatNotifyToggle : $('#chatNotifyToggle'),
				formGroup1 : $('#formGroup1'),
				formGroup2 : $('#formGroup2'),
				formGroup3 : $('#formGroup3'),
				editorContainer : $('#editorContainer'),
				chatContainer : $('#chatContainer'),
				mobileEditor : $('#mobileEditor'),
				editorInputBtn : $('#editorInputBtn'),
				btnGroup1 : $('#btnGroup1'),
				btnGroup2 : $('#btnGroup2'),
				basicStatus : $('#basicStatus'),
				mobileStatus : $('#mobileStatus'),
				basicStatusBadge : $('#basicStatusBadge'),
				mobileStatusBadge : $('#mobileStatusBadge'),
				IMColla : $('#IMColla'),
				editorBtnGroupDiv : $('#editorBtnGroupDiv'),
				
			};
			
		// socket(SockJS)
		var session = {
			
			socket : null,
			nickname : null,
			
			connect : function() {
				var URL = location.protocol + '//' + location.host;
				this.socket = new SockJS(URL + '/myPractice/socket');
				this.socket.onopen = function(event) {
					notify.notifyChat('연결 성공', 'success');
				};
				this.socket.onclose = function(event) {
					notify.notifyChat('연결 종료', 'success');
					
					// Unespected disconnection
					if (jqObj.joinToggleBtn.html() == ('Exit')) {
						utils.chatAppend('Unstable disconnection happened!');
						utils.chatAppend('Please join again!');
						jqObj.joinToggleBtn.html('Join');
						jqObj.joinToggleBtn.removeClass('btn-danger');
						jqObj.joinToggleBtn.addClass('btn-success');
					}
				};
				
				this.socket.onmessage = function(event) {
					utils.chatAppend(event.data);
					notify.notifyChat(event.data);
					badge.add();
				};
				this.socket.onerror = function(event) {
					alert('에러 발생 : ' + event.data);
				};
				
				URL = null;
			},
			
			disconnect : function() {
				this.socket.send(this.nickname + ' 님이 퇴장했습니다.');
				this.socket.close();
				this.socket = null;
				this.nickname = null;
			},
			
			// Send data to socket
			send : function() {
				var msg = jqObj.chatInput.val();
				utils.chatAppend('나 : ' + msg);
				this.socket.send(this.nickname + ' : ' + msg);
				jqObj.chatInput.val('');
				msg = null;
			}
		};

		var badge = {
			
			msgCnt : 0,
			badgeArray : $('.badge'),
			badgeBtnArray : [ jqObj.basicStatus, jqObj.mobileStatus ],
			
			add : function() {
				if(this.msgCnt == 0) {
					utils.removeClassFunc(this.badgeBtnArray, 'btn-primary');
					utils.addClassFunc(this.badgeBtnArray, 'btn-warning');
				}
				this.badgeArray.text(++this.msgCnt);
			},
			
			reset : function() {
				this.msgCnt = 0;
				this.badgeArray.text(0);
				utils.removeClassFunc(this.badgeBtnArray, 'btn-warning');
				utils.addClassFunc(this.badgeBtnArray, 'btn-primary');
			}
			
		};
		
		var notify = {
				
			toggle : true,
			
			notifyChat : function(msg, type) {
				if(!type)
					type = 'info'; 
				if (this.toggle)
					$.notify(msg, type);				
			},
			
			toggleChatNotify : function() {
				
				var str = 'data-original-title';
				
				this.toggle = !this.toggle;
				jqObj.chatNotifyToggle.toggleClass('glyphicon-eye-close');
				jqObj.chatNotifyToggle.toggleClass('glyphicon-eye-open');
				if(this.toggle) {
					jqObj.chatNotifyToggleBtn.attr(str, 'Hide chat notification!').tooltip('hide');			        
				}
				else {
					jqObj.chatNotifyToggleBtn.attr(str, 'Show chat notification!').tooltip('hide');
				}
			}
		};
		
		var utils = {
			// chatArea append function
			chatAppend : function(str) {
				jqObj.chatArea.append(str + '\n');
				jqObj.chatArea.scrollTop(jqObj.chatArea[0].scrollHeight);
			},
				
			toggleClassArrayFunc : function(array, str) {
				for ( var ctr in array)
					array[ctr].toggleClass(str);
			},
			
			addClassFunc : function(array, str) {
				for ( var ctr in array)
					array[ctr].addClass(str);
			},
			
			removeClassFunc : function(array, str) {
				for ( var ctr in array)
					array[ctr].removeClass(str);
			},
				
			// Check if string is not both null and empty
			checkStr : function(str) {
				//<![CDATA[
				if (((typeof str != "undefined") && (typeof str.valueOf() == "string")) && (str.length > 0))
					return true;
				else
					return false;
				//]]>
			},
			
			// veryfy chat input
			verifyChatInput : function() {
				if (!session.socket) {
					notify.notifyChat('You need to join first!');
					jqObj.nicknameInput.focus();
				} else if (!(this.checkStr(jqObj.chatInput.val()))) {
					jqObj.chatInput.focus();
				} else {
					session.send();
					jqObj.chatInput.focus();
				}
			},
			
			// Verify and control Join condition
			verifyJoin : function() {
				if (!session.socket) {
					if (this.checkStr(jqObj.nicknameInput.val())) {
						// this.chatAppend('Join now!');
						jqObj.joinToggleBtn.html('Exit');
						jqObj.joinToggleBtn.removeClass('btn-success');
						jqObj.joinToggleBtn.addClass('btn-danger');
						session.nickname = jqObj.nicknameInput.val();
						jqObj.nicknameInput.val('');
						jqObj.nicknameInput.attr('placeholder', 'Login is successful!');
						session.connect();
						jqObj.chatInput.focus();
					} else {
						jqObj.nicknameInput.attr('placeholder', 'Worng! type again!');
						jqObj.nicknameInput.focus();
					}
				} else {
					// this.chatAppend('Exit now!');
					jqObj.joinToggleBtn.html('Join');
					jqObj.joinToggleBtn.removeClass('btn-danger');
					jqObj.joinToggleBtn.addClass('btn-success');
					jqObj.nicknameInput.val('');
					jqObj.nicknameInput.attr('placeholder', 'Type nickname');
					session.disconnect();
					jqObj.nicknameInput.focus();
				}
			},
			
			showHeight : function() {
				// Each height
				this.chatAppend('#window : ' + $(window).height());
				this.chatAppend('#container : ' + $('#container').height());
				this.chatAppend('#navBarContainer: ' + $('#navBarContainer').height());
				this.chatAppend('#mainRow : ' + $('#mainRow').height());
				this.chatAppend('#editorContainer : ' + jqObj.editorContainer.height());
				this.chatAppend('#chatContainer : ' + jqObj.chatContainer.height());
				this.chatAppend('#basicEditorDiv : ' + $('#basicEditorDiv').height());
				this.chatAppend('#mobileEditorDiv : ' + $('#mobileEditorDiv').height());
				this.chatAppend('#basicEditor : ' + $('#basicEditor').height());
				this.chatAppend("#basicEditor.config.height : " + basicEditor.config.height);
				this.chatAppend('#mobileEditor : ' + jqObj.mobileEditor.height());
				this.chatAppend('#chatArea : ' + jqObj.chatArea.height());
				this.chatAppend('#chatContainer - editorContainer : ' + (jqObj.chatContainer.height() - jqObj.editorContainer.height()));
			}
		};

		var eventFuncs = {
			tooltipActivate : function() {
				$('[data-toggle="tooltip"]').tooltip();
			},
			
			focusBackToChatInput : function() {
				// Focus back to chatInput on pressing enter key on chatInput
				jqObj.chatInput.keypress(function(event) {
					if (event.keyCode === 13) {
						utils.verifyChatInput();
					}
				});
				// Focus back to chatInput on clicking chatInputBtn
				jqObj.chatInputBtn.click(function() {
					utils.verifyChatInput();
				});
			},
			
			badgeEvent : function() {
				// Badge event function
				jqObj.chatArea.focus(function(event) {
					badge.reset();
				});
				jqObj.chatInput.focus(function(event) {
					badge.reset();
				});
				jqObj.basicStatus.click(function() {
					badge.reset();
				});
				jqObj.mobileStatus.click(function() {
					badge.reset();
				});
			},
			
			// Toggle chat notification
			toggleChatNotifyEvent : function() {
				jqObj.chatNotifyToggleBtn.click(function() {
					notify.toggleChatNotify();
				});
			},
			
			toggleJoinEvent : function() {
				// Toggle join (button)
				jqObj.joinToggleBtn.click(function() {
					utils.verifyJoin();
				});
				// Toggle join (input text)
				jqObj.nicknameInput.keypress(function(event) {
					if (event.keyCode === 13)
						utils.verifyJoin();
				});
			},
			
			// Toggle toolbar function
			toggleToolbarFunc : function() {
				setTimeout(function() {
					this.toggle = !this.toggle;
					$('#cke_1_top').toggle();
					$('#cke_2_top').toggle();
					jqObj.toolbarToggle.toggleClass('glyphicon-ice-lolly-tasted');
					jqObj.toolbarToggle.toggleClass('glyphicon-ice-lolly');
					if (matchMedia("screen and (min-width: 768px)").matches) {
						resizeFuncs.setBasicHeight();
						basicEditor.focus();
					} else {
						jqObj.mobileEditor.focus();
					}
				}, 135);
				
				setTimeout(function() {
					
					var str = 'data-original-title';
					
					if(jqObj.toolbarToggle.hasClass('glyphicon-ice-lolly-tasted')) {
						jqObj.toolbarToggleBtn.attr(str, 'Hide toolbar!').tooltip('hide');
						jqObj.basicStatus.attr(str, 'Hide toolbar!').tooltip('hide');
						jqObj.mobileStatus.attr(str, 'Hide toolbar!').tooltip('hide');
					} else {
						jqObj.toolbarToggleBtn.attr(str, 'Show toolbar!').tooltip('hide');
						jqObj.basicStatus.attr(str, 'Show toolbar!').tooltip('hide');
						jqObj.mobileStatus.attr(str, 'Show toolbar!').tooltip('hide');
					}
				}, 135);
			},
			
			// Toggle toolbar
			toggleToolbarEvent : function() {
				jqObj.toolbarToggleBtn.click(function() {
					eventFuncs.toggleToolbarFunc();
				});
				jqObj.basicStatus.click(function() {
					eventFuncs.toggleToolbarFunc();
					badge.reset();
				});
				jqObj.mobileStatus.click(function() {
					eventFuncs.toggleToolbarFunc();
				});
			},
			
			windowOutEvent : function() {
				// Logout, close event with 'esc' key on browser window
				$(window).keydown(function(event) {
					if (event.keyCode == 27) {
						utils.chatAppend('esc!!');
						if (session.socket) {
							// utils.chatAppend('Exit now!');
							jqObj.joinToggleBtn.html('Join');
							jqObj.joinToggleBtn.removeClass('btn-danger');
							jqObj.joinToggleBtn.addClass('btn-success');
							jqObj.nicknameInput.val('');
							jqObj.nicknameInput.attr('placeholder', 'Type nickname');
							session.disconnect();
							session.nickname = null;
							jqObj.nicknameInput.focus();
						} else {
							// 창 닫는 함수 (작동 안 함)
							// window.open("about:blank","_self").close();
						}
					}
				});
			},
			
			showHeights : function() {
				$('#showHeights').click(function() {
					utils.showHeight();
				});
			},
			
			addAll() {
				this.focusBackToChatInput();
				this.badgeEvent();
				this.toggleJoinEvent();
				this.toggleToolbarEvent();
				this.windowOutEvent();
				this.showHeights();
				this.tooltipActivate();
				this.toggleChatNotifyEvent();
			}
			
		};
		var resizeFuncs = {
			
			// There was a problem that editor's height is not compatible with chatArea's one at some point
			// I think it was from CKEditor's toolbar height changes.
			// So I've deicded to use an if statement to ensure it's compatible when resizing
			checkEditorHeightAgainAndResize : function() {
				if (jqObj.editorContainer.height() != jqObj.chatContainer.height()) {
					basicEditor.resize('100%', jqObj.chatArea.height() + 63);
				}
			},
			
			setInitialBasicHeight : function() {
				jqObj.chatArea.height($(window).height() - 175);
				// CKEditor is loaded at the last moment, so I used 'on' method from CKEditor
				basicEditor.on('instanceReady', function() {
					basicEditor.resize('100%', jqObj.chatArea.height() + 63);
					this.checkEditorHeightAgainAndResize();
				});
			},
			
			setBasicHeight : function() {
				jqObj.chatArea.height($(window).height() - 175);
				basicEditor.resize('100%', jqObj.chatArea.height() + 63);
				this.checkEditorHeightAgainAndResize();
			},
			
			setMobileHeight : function() {
				jqObj.mobileEditor.height($(window).height() - 320);
				jqObj.chatArea.height($(window).height() - jqObj.mobileEditor.height() - 192);
			}
			
		};
		
// ===================================================================================================
		
		// == $(function() {
		$(document).ready(function() {
			
			// add element event
			eventFuncs.addAll();
			
			// this is for only testing
			jqObj.nicknameInput.focus();
			
			// arrays to set different sets between basic and mobile
			var formGroupArray = [ jqObj.formGroup1, jqObj.formGroup2, jqObj.formGroup3 ];
			var formControlArray = [ jqObj.chatInputBtn ];
			var btnGroupArray = [ jqObj.btnGroup1, jqObj.btnGroup2 ];
			// Initial setting
			if (matchMedia("screen and (min-width: 768px)").matches) {
				// utils.chatAppend("큰 화면 전용");
				resizeFuncs.setInitialBasicHeight();
			} else {
				// utils.chatAppend("작은 화면 전용");
				utils.removeClassFunc(formGroupArray, 'form-group');
				utils.addClassFunc(formControlArray, 'form-control');
				utils.addClassFunc(btnGroupArray, 'btn-group-justified');
				resizeFuncs.setMobileHeight();
			}
			// initial size setting of calendar in modal
			calendar.fullCalendar('option', 'contentHeight', $(window).height() * 0.5);
			
			$(window).resize(function() {
				
				// resize calendar in modal
				calendar.fullCalendar('option', 'contentHeight', $(window).height() * 0.5);
				
				// To basic from mobile
				if (matchMedia("screen and (min-width: 768px)").matches) {
					// resize editor, chatArea
					resizeFuncs.setBasicHeight();
					// Applied only once after mode has been changed
					if (!(formGroupArray[0].hasClass('form-group'))) {
						// utils.chatAppend("큰 화면 전용");
						utils.removeClassFunc(formControlArray, 'form-control');
						utils.addClassFunc(formGroupArray, 'form-group');
						utils.removeClassFunc(btnGroupArray, 'btn-group-justified');
						resizeFuncs.setBasicHeight();
					}
				} else { // To mobile from basic
					// resize editor, chatArea
					resizeFuncs.setMobileHeight();
					// // Applied only once after mode has been changed
					if (formGroupArray[0].hasClass('form-group')) {
						// utils.chatAppend("작은 화면 전용");
						utils.removeClassFunc(formGroupArray, 'form-group');
						utils.addClassFunc(formControlArray, 'form-control');
						utils.addClassFunc(btnGroupArray, 'btn-group-justified');
						resizeFuncs.setMobileHeight();
					}
				}
			}).resize();
		});
	</script>
</body>
</html>